# Jenkins Pipeline设计

​	使用Jenkins搭建微服务平台Pipeline，实现代码提交后的编译、测试、部署等步骤，让开发人员可以快速、直观的得到有效反馈，达到微服务开发过程中持续交付、持续集成的目的。通过Pipeline固化交付和部署流程，解放人力，避免手工操作引起的错误和人员流动带来的交接问题。



## 相关服务

 - GitLab 版本管理
 - Maven 工程管理和整合
 - Nexus 制品管理
 - Sonar 代码质量管理
 - Docker 容器引擎



## Pipeline设计

​	DEV、SIT、UAT、TAG、PROD四个环境统一Pipeline步骤，以及其他补充场景Pipleline

。



### DEV

​	DEV环境为开发测试环境，是开发人员开发和自测依赖的环境，我们要保证这个环境的完整性和时效性。DEV环境是持续集成的核心。

​	DEV环境流水线定义如下：



1. 代码检出——从GitLab上检出代码
2. 静态代码检查——检查代码是否符合代码规范，依赖check-style.xml
3. 单元测试——使用maven进行单元测试、契约测试，并提交单元测试结果到Sonar，依赖maven的jacoco插件
4. 编译发布——maven打包，不要单元测试，将jar发布到Nexus服务器
5. 生成Docker镜像——将上一步中jar包打成Docker镜像，将镜像发布到Nexus服务器
6. 部署——通过jar包或镜像启动DEV环境



​	注意事项：

- 需要记录build no与制品之间的关系，以供后续流水线使用。
- 需要记录从GitLab上获取的代码的版本号





## SIT

​	SIT环境是测试人员测试环境，可能存在多个SIT环境用于不同项目测试。SIT环境要保证环境的稳定性，确定大致的部署时间，尽量减少环境部署对测试人员的影响，一般SIT环境部署由测试人员自己操作，可以与开发人员确认部署版本。

​	SIT环境流水线定义如下：

1. 选择部署版本——输入一个DEV的build no进行SIT部署
2. 代码检出——从GitLab检出代码（流水线相关的脚本）
3. 获取制品——根据build no从Nexus上拉取对应制品
4. 部署——在SIT环境服务器上启动制品



​	注意事项：



## UAT

​	UAT环境是用户验收环境，测试人员根据SIT测试结果从测试通过的版本中选择一个部署到UAT环境，提交用户验收，根据用户验收情况确认该版本是否发布到生产环境。

​	UAT环境流水线定义如下：

1. 选择部署版本——输入一个DEV的build no进行UAT部署
2. 代码检出——从GitLab检出代码（流水线相关的脚本）
3. 获取制品——根据build no从Nexus上拉取对应制品
4. 部署——在UAT环境服务器上启动制品



​	注意事项：

- 如果项目上线周期较长，可以考虑加入创建tag版本的步骤，tag版可用于线上bug修复。



## TAG

​	TAG环境主要用于线上bug修复。如果CICD整体比较完善，从开发到发布时间较短，bug修复完全可以跟着上线流程上线，如果上线周期较长，需要考虑加入TAG环境，修复线上问题。

​	TAG环境流水线定于如下：

1. 选择部署版本——输入GitLab仓库分支版本进行TAG部署
2. 代码检出——从GitLab上检出分支代码
3. 静态代码检查——检查代码是否符合代码规范，依赖check-style.xml
4. 单元测试——使用maven进行单元测试、契约测试，这里单元测试结果可以不提交，代码合并后会在DEV流水中提交
5. 编译发布——maven打包，不要单元测试，将jar发布到Nexus服务器
6. 生成Docker镜像——将上一步中jar包打成Docker镜像，将镜像发布到Nexus服务器
7. 部署——通过jar包或镜像启动TAG环境



​	注意事项：

- TAG环境整体上与线上环境保持一致，可以在上线部署时，同时部署TAG环境。
- bug修复是从master的历史版本创建一个分支修改代码，开发自测通过后，直接部署到TAG环境，对应的SIT、UAT测试都在TAG环境操作。
- TAG也记录build no与制品之间的关系，TAG环境pipeline生成的制品命名上要与DEV环境的不一样



## PROD

​	PROD环境是线上环境，是提供客户使用的真实环境，版本部署操作需要有严格控制。

​	PROD环境流水线如下：

1. 选择部署版本——输入一个制品的版本
2. 获取制品——从Nexus上拉取对应制品
3. 部署——在PROD环境服务器上启动制品



​	如果生产部署环境与Nexus不通，流水线如下：

1. 上传需要部署的制品——手动上传到pipeline读取的目录下
2. 部署——在PROD环境服务器上启动制品



##  工程漏洞扫描

​	开发人员引入的jar中可能会存在漏洞，为了防止jar包漏洞对系统造成影响，我们需要定时对工程中依赖的jar包进行漏洞扫描，一般漏洞扫描放在晚上或者周末进行。

​	下面是基于OWASP实现的简单漏洞扫描，分为两个步骤，一是漏洞信息更新，二是工程漏洞扫描，都可以通过maven 插件实现。

​	

### 漏洞信息更新

​	OWASP的漏洞信息来源于NVD，NVD会定期发布一些新增的漏洞信息，我们需要将这些漏洞新增更新到本地数据库中。

1. 构造pom文件——创建一个更新漏洞信息的pom文件

2. 执行更新——调用maven命令更新漏洞信息

   

   注意事项：

- 如果文件下载较慢，可以手动下载后放到某个固定目录中



### 工程漏洞扫描

1. 代码检出——从GitLab上检出代码
2. 漏洞检查——检查依赖中是否存在漏洞
3. 发送漏洞报告——将生成的报告发送到web工程中，提供检索查看



​	注意事项：

- 前置条件：漏洞信息更新流水线执行完成
- 项目经理可以在第二天查看上一天跑出来的测试报告
- 测试报告中的漏洞需要保证无法被攻击者利用，如果存在风险的需要在上线前修改